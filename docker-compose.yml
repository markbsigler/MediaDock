x-common-env-vars: &common-env-vars
  TZ: America/New_York
  PGID: 1000
  PUID: 1000
  UMASK: 2

x-logging: &logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-restart-policy: &restart-policy "unless-stopped"

services:
  # Bazarr - Subtitle management for Radarr and Sonarr
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    depends_on:
      - radarr
      - sonarr
    volumes:
      - /srv/share/container/bazarr/config:/config
      - /srv/share/media/videos/movies:/movies
      - /srv/share/media/videos/tv:/tv
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *common-env-vars
    ports:
      - "127.0.0.1:6767:6767"
    networks:
      - bridge_media
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6767 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    hostname: bazarr
    mem_limit: 256m
    mem_reservation: 128m
  delugevpn:
    image: binhex/arch-delugevpn
    container_name: delugevpn
    volumes:
      - /srv/share/container/delugevpn/config:/config
      - /srv/share/downloads:/data
      - /etc/localtime:/etc/localtime:ro
    secrets:
      - vpn_username
      - vpn_password
    environment:
      <<: *common-env-vars
      VPN_ENABLED: "yes"
      VPN_PROV: pia
      VPN_CLIENT: wireguard
      STRICT_PORT_FORWARD: "yes"
      ENABLE_PRIVOXY: "yes"
      LAN_NETWORK: 10.0.0.0/24
      NAME_SERVERS: 1.1.1.1,1.0.0.1,8.8.8.8,8.8.4.4
      DELUGE_DAEMON_LOG_LEVEL: info
      DELUGE_WEB_LOG_LEVEL: info
      DELUGE_ENABLE_WEBUI_PASSWORD: "yes"
      DEBUG: "false"
    ports:
      - "127.0.0.1:8112:8112"
      - "127.0.0.1:8118:8118"
      - "127.0.0.1:58846:58846"
      - "127.0.0.1:58946:58946"
    networks:
      - bridge_media
        #    depends_on:
        #      - nzbgetvpn
    command: >
      sh -c '
        export VPN_USER=$(cat /run/secrets/vpn_username)
        export VPN_PASS=$(cat /run/secrets/vpn_password)
        exec /bin/bash init.sh
      '
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8112 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    cap_add:
      - NET_ADMIN
    hostname: delugevpn
    mem_limit: 1g
    mem_reservation: 512m
    privileged: true
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1

  # FlareSolverr - Cloudflare bypass for Prowlarr
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      <<: *common-env-vars
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_HTML: ${LOG_HTML:-false}
      CAPTCHA_SOLVER: ${CAPTCHA_SOLVER:-none}
    ports:
      - "127.0.0.1:${PORT:-8191}:8191"
    networks:
      - bridge_media
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8191 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    hostname: flaresolverr
    mem_limit: 512m
    mem_reservation: 256m

  # Lidarr - Music management and automation
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    depends_on:
      - delugevpn #      - nzbgetvpn
      - prowlarr
    volumes:
      - /srv/share/container/lidarr/config:/config
      - /srv/share/media/music:/music
      - /srv/share/downloads:/downloads
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *common-env-vars
    ports:
      - "127.0.0.1:8686:8686"
    networks:
      - bridge_media
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8686/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    hostname: lidarr
    mem_limit: 512m
    mem_reservation: 256m

  # Prowlarr - Indexer manager for *arr apps
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    depends_on:
      - flaresolverr
    volumes:
      - /srv/share/container/prowlarr/config:/config
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *common-env-vars
    ports:
      - "127.0.0.1:9696:9696"
    networks:
      - bridge_media
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9696/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    hostname: prowlarr
    mem_limit: 256m
    mem_reservation: 128m

  # Radarr - Movie management and automation
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    depends_on:
      - delugevpn #      - nzbgetvpn
      - prowlarr
    volumes:
      - /srv/share/container/radarr/config:/config
      - /srv/share/media/videos/movies:/movies
      - /srv/share/downloads:/downloads
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *common-env-vars
    ports:
      - "127.0.0.1:7878:7878"
    networks:
      - bridge_media
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7878/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging
    hostname: radarr
    mem_limit: 512m
    mem_reservation: 256m

  # Sonarr - TV show management and automation
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    depends_on:
      - delugevpn
      - prowlarr
    volumes:
      - /srv/share/container/sonarr/config:/config
      - /srv/share/media/videos/tv:/tv
      - /srv/share/downloads:/downloads
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *common-env-vars
    ports:
      - "127.0.0.1:8989:8989"
    networks:
      - bridge_media
    restart: *restart-policy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8989/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    #  - nzbgetvpn
    logging: *logging
    hostname: sonarr
    mem_limit: 512m
    mem_reservation: 256m

networks:
  bridge_media:
    driver: bridge

secrets:
  vpn_username:
    file: ./vpn_username.txt
  vpn_password:
    file: ./vpn_password.txt
